import re
from py2neo import Graph

# Connessione al database Neo4j
graph = Graph("bolt://localhost:7688", auth=("neo4j", "scottdirT98"))

# Query per estrarre tutte le descrizioni
query = """
MATCH (n)
WHERE n:Malware OR n:Technique OR n:Procedure OR n:Detection OR n:Mitigation
RETURN n.name AS name, n.description AS description;
"""
data = graph.run(query).data()

# Funzione per cercare CVE nelle descrizioni
def find_cve(description):
    cve_pattern = r'CVE-\d{4}-\d{4,7}'
    if isinstance(description, str):
        matches = re.findall(cve_pattern, description)
        return matches
    else:
        return []

# Analisi delle descrizioni
results = []
for entry in data:
    name = entry['name']
    description = entry['description']
    cve_matches = find_cve(description)
    if cve_matches:
        results.append((name, cve_matches))

# Stampa dei risultati
for name, cves in results:
    print(f"Node: {name}")
    for cve in cves:
        print(f"  CVE: {cve}")
