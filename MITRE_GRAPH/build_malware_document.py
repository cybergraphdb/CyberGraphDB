import logging

import manager_html_reference
import manager_pdf_references
from tqdm import tqdm

# Configura il sistema di logging
logging.basicConfig(
    filename="Error_Document-DB.log",
    level=logging.ERROR,
    format="%(asctime)s - %(levelname)s: %(message)s",
)


def build_document(malware_name, malware_page_references):
    print("\n\n[!!!] Building Malware Document ... \n")
    for ref in tqdm(
        malware_page_references, leave=False
    ):  # Imposta leave=False per nascondere la barra di avanzamento
        try:
            if ".pdf" in ref:
                extracted_text = manager_pdf_references.extract_text_from_pdf(ref)
                extracted_text = extracted_text.decode("utf-8")
            else:
                extracted_text = manager_html_reference.extract_text_from_html(ref)
            complete_path = f"C:\\Users\\marco\\python_version\\MALWARE_DOCUMENTS\\{malware_name}_document"
            with open(complete_path, "a", encoding="utf-8") as f:
                f.write(
                    f"\n\n --------------- Content of Ref: {ref} -----------------------\n"
                )
                f.write(str(extracted_text))
        except Exception as e:
            # print("[!] - Error in building the Document")
            # print(e)
            # Registra l'errore nel file di log
            error_string = f"The url {ref} has presented this error:\n" + str(e)
            logging.error(error_string, exc_info=True)
            pass
